<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Outgoing Webhooks</title>

    <link href="../stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
      <script src="../javascripts/all.js" type="text/javascript"></script>

      <script>
        $(function() {
          setupLanguages(["ruby"]);
        });
      </script>
  </head>

  <body class="webhooks webhooks_index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="../images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <a href="/"><img src="../images/logo.png" /></a>
        <div class="lang-selector">
              <a href="#" data-language-name="ruby">ruby</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='https://www.wootric.com/'>Sign Up</a></li>
            <li><a href='http://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='outgoing-webhooks'>Outgoing Webhooks</h1>
<p>Wootric can send an HTTP POST request to a specified URL when an event occurs. See the list of supported events below. </p>
<h2 id='list-of-events-and-their-payload'>List of events and their payload</h2><pre><code class="highlight ruby"><span class="c1"># response created sample payload</span>
<span class="n">response</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">=</span><span class="mi">1128</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">score</span><span class="p">]</span><span class="o">=</span><span class="mi">7</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">text</span><span class="p">]</span><span class="o">=&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">ip_address</span><span class="p">]</span><span class="o">=</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">origin_url</span><span class="p">]</span><span class="o">=</span><span class="n">https</span><span class="o">%</span><span class="mi">3</span><span class="no">A</span><span class="o">%</span><span class="mi">2</span><span class="no">F</span><span class="o">%</span><span class="mi">2</span><span class="no">Fwootric</span><span class="p">.</span><span class="nf">com</span><span class="o">%</span><span class="mi">2</span><span class="no">F</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">end_user_id</span><span class="p">]</span><span class="o">=</span><span class="mi">30</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">end_user_properties</span><span class="p">][</span><span class="n">pricing_plan</span><span class="p">]</span><span class="o">=</span><span class="no">Enterprise</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">end_user_properties</span><span class="p">][</span><span class="n">product_plan</span><span class="p">]</span><span class="o">=</span><span class="no">Web</span><span class="o">%</span><span class="mi">20</span><span class="no">App</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">survey_id</span><span class="p">]</span><span class="o">=</span><span class="mi">1146</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">created_at</span><span class="p">]</span><span class="o">=</span><span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">04</span><span class="o">%</span><span class="mi">2013</span><span class="o">%</span><span class="mi">3</span><span class="no">A57</span><span class="o">%</span><span class="mi">3</span><span class="no">A26</span><span class="o">%</span><span class="mi">20</span><span class="o">-</span><span class="mo">0700</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">updated_at</span><span class="p">]</span><span class="o">=</span><span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">04</span><span class="o">%</span><span class="mi">2013</span><span class="o">%</span><span class="mi">3</span><span class="no">A57</span><span class="o">%</span><span class="mi">3</span><span class="no">A26</span><span class="o">%</span><span class="mi">20</span><span class="o">-</span><span class="mo">0700</span><span class="o">&amp;</span>
<span class="n">response</span><span class="p">[</span><span class="n">excluded_from_calculations</span><span class="p">]</span><span class="o">=</span><span class="kp">false</span><span class="o">&amp;</span>
<span class="n">event_name</span><span class="o">=</span><span class="n">created</span><span class="o">&amp;</span>
<span class="n">timestamp</span><span class="o">=</span><span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">04</span><span class="o">%</span><span class="mi">2013</span><span class="o">%</span><span class="mi">3</span><span class="no">A57</span><span class="o">%</span><span class="mi">3</span><span class="no">A31</span><span class="o">%</span><span class="mi">20</span><span class="o">-</span><span class="mo">0700</span>

<span class="c1"># decline created sample payload</span>
<span class="n">decline</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">=</span><span class="mi">19</span><span class="o">&amp;</span>
<span class="n">decline</span><span class="p">[</span><span class="n">ip_address</span><span class="p">]</span><span class="o">=</span><span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">&amp;</span>
<span class="n">decline</span><span class="p">[</span><span class="n">origin_url</span><span class="p">]</span><span class="o">=</span><span class="n">https</span><span class="o">%</span><span class="mi">3</span><span class="no">A</span><span class="o">%</span><span class="mi">2</span><span class="no">F</span><span class="o">%</span><span class="mi">2</span><span class="no">Fwootric</span><span class="p">.</span><span class="nf">com</span><span class="o">%</span><span class="mi">2</span><span class="no">F</span><span class="o">&amp;</span>
<span class="n">decline</span><span class="p">[</span><span class="n">end_user_id</span><span class="p">]</span><span class="o">=</span><span class="mi">31</span><span class="o">&amp;</span>
<span class="n">decline</span><span class="p">[</span><span class="n">end_user_properties</span><span class="p">][</span><span class="n">pricing_plan</span><span class="p">]</span><span class="o">=</span><span class="no">Pro</span><span class="o">&amp;</span>
<span class="n">decline</span><span class="p">[</span><span class="n">end_user_properties</span><span class="p">][</span><span class="n">product_plan</span><span class="p">]</span><span class="o">=</span><span class="no">Web</span><span class="o">%</span><span class="mi">20</span><span class="no">App</span><span class="o">&amp;</span>
<span class="n">decline</span><span class="p">[</span><span class="n">survey_id</span><span class="p">]</span><span class="o">=</span><span class="mi">1147</span><span class="o">&amp;</span>
<span class="n">decline</span><span class="p">[</span><span class="n">created_at</span><span class="p">]</span><span class="o">=</span><span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">04</span><span class="o">%</span><span class="mi">2013</span><span class="o">%</span><span class="mi">3</span><span class="no">A58</span><span class="o">%</span><span class="mi">3</span><span class="no">A21</span><span class="o">%</span><span class="mi">20</span><span class="o">-</span><span class="mo">0700</span><span class="o">&amp;</span>
<span class="n">decline</span><span class="p">[</span><span class="n">updated_at</span><span class="p">]</span><span class="o">=</span><span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">04</span><span class="o">%</span><span class="mi">2013</span><span class="o">%</span><span class="mi">3</span><span class="no">A58</span><span class="o">%</span><span class="mi">3</span><span class="no">A21</span><span class="o">%</span><span class="mi">20</span><span class="o">-</span><span class="mo">0700</span><span class="o">&amp;</span>
<span class="n">event_name</span><span class="o">=</span><span class="n">created</span><span class="o">&amp;</span>
<span class="n">timestamp</span><span class="o">=</span><span class="mi">2016</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">04</span><span class="o">%</span><span class="mi">2013</span><span class="o">%</span><span class="mi">3</span><span class="no">A58</span><span class="o">%</span><span class="mi">3</span><span class="no">A23</span><span class="o">%</span><span class="mi">20</span><span class="o">-</span><span class="mo">0700</span>
</code></pre>

<ul>
<li><strong>Response created:</strong> An end user responded to a survey.</li>
<li><strong>Response updated:</strong> An end user changed the score or added feedback to a response.</li>
<li><strong>Decline created:</strong> An end user dismissed the survey popup.</li>
</ul>
<h2 id='setup'>Setup</h2>
<p>Webhooks are enabled in the <strong>Outgoing Webhooks</strong> page in the settings, by selecting the required events and adding the URL. The specified URL needs to be publicly accessible.</p>

<p>That&rsquo;s it! Wootric will be sending a POST request to the specified URL when the event happens!</p>
<h2 id='security'>Security</h2><pre><code class="highlight ruby"><span class="nb">require</span> <span class="s1">'cuba'</span>
<span class="nb">require</span> <span class="s1">'openssl'</span>

<span class="no">Cuba</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
  <span class="n">on</span> <span class="n">post</span> <span class="k">do</span>
    <span class="n">on</span> <span class="n">root</span> <span class="k">do</span>
      <span class="n">body</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">read</span>
      <span class="n">req</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">rewind</span>
      <span class="n">calculated_digest</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">HMAC</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="s1">'sha1'</span><span class="p">,</span> <span class="s1">'09dfb1b73af998743fb011f8bfda8912'</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

      <span class="k">if</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="p">.</span><span class="nf">secure_compare</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="nf">env</span><span class="p">[</span><span class="s1">'HTTP_X_WOOTRIC_SIGNATURE'</span><span class="p">],</span> <span class="s2">"sha1=</span><span class="si">#{</span><span class="n">calculated_digest</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">.</span><span class="nf">has_key?</span><span class="p">(</span><span class="s1">'response'</span><span class="p">)</span>
          <span class="k">case</span> <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'event_name'</span><span class="p">]</span>
          <span class="k">when</span> <span class="s1">'created'</span>
            <span class="nb">puts</span> <span class="s2">"Response submitted with a score of </span><span class="si">#{</span><span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'response'</span><span class="p">][</span><span class="s1">'score'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
          <span class="k">when</span> <span class="s1">'updated'</span>
            <span class="nb">puts</span> <span class="s2">"Response updated with a score of </span><span class="si">#{</span><span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'response'</span><span class="p">][</span><span class="s1">'score'</span><span class="p">]</span><span class="si">}</span><span class="s2"> and the following comment: </span><span class="si">#{</span><span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">[</span><span class="s1">'response'</span><span class="p">][</span><span class="s1">'text'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
          <span class="k">end</span>
        <span class="k">elsif</span> <span class="n">req</span><span class="p">.</span><span class="nf">params</span><span class="p">.</span><span class="nf">has_key?</span><span class="p">(</span><span class="s1">'decline'</span><span class="p">)</span>
          <span class="nb">puts</span> <span class="s1">'Survey declined'</span>
        <span class="k">end</span>
      <span class="k">else</span>
        <span class="nb">puts</span> <span class="s2">"Ignoring request with invalid signature from ip </span><span class="si">#{</span><span class="n">req</span><span class="p">.</span><span class="nf">ip</span><span class="si">}</span><span class="s2">"</span>
      <span class="k">end</span>

      <span class="n">res</span><span class="p">.</span><span class="nf">write</span> <span class="s1">''</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>In order to verify that the request actually came from our servers, we include the <code class="prettyprint">HTTP_X_WOOTRIC_SIGNATURE</code> header, which is an HMAC-SHA1 signature of the payload using the secret token for your account. You can get this token in the <strong>Outgoing Webhooks</strong> configuration page.</p>


      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="ruby">ruby</a>
          </div>
      </div>
    </div>
  </body>
</html>
